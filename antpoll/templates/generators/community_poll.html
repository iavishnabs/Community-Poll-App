<style>
        body {
          background-color: #f2edf3 !important;
          background: #f2edf3;
          font-family: 'Segoe UI', sans-serif;
          margin: 0;
          padding: 0;
          height: 100vh;
          overflow: hidden;
        }
      
        .poll-wrapper {
          display: flex;
          flex-direction: column;
          
        }
      
        .dashboard {
          width: 100%;
          margin: auto;
          padding: 2rem;
        }
      
        .dashboard-2col-qstn {
          display: flex;
          flex-direction: column;
          gap: 1rem;
          background: transparent;
          position: relative;
          color: white;
        }
        .dashboard-2col {
            display: grid;
            grid-template-columns: 400px 800px; /* First column smaller, second bigger */
            gap: 2rem;
            justify-content: center; /* Center the whole grid nicely */
            width: 100%;
          }
          
        .card-result, .card-leaderb {
          box-sizing: border-box;
          height: auto;
        }
          
        /* Specific styles for Result card */
        .card-result {
          display: flex;
          flex-direction: column; /* Arrange inside vertically */
          max-width: 400px;
          width: 100%;
          background: #f9f9f9; /* optional, light background */
          padding: 1rem; /* some padding inside */
          border-radius: 8px; /* rounded corners */
        }
          /* Specific styles for Leaderboard card */
          .card-leaderb {
          max-width: 800px;
          width: 100%;
          background: #ffffff; /* optional */
          padding: 1rem;
          border-radius: 8px;
        }
              
        /* Inside .card-result, two sections: answer and chart */
        .card-result-answer {
          margin-bottom: 1rem; /* gap between answer and chart */
          font-size: 1.2rem;
          font-weight: bold;
          padding: 20px 10px;
        }
        .card-result-answer .anss{
          background: #e0c6f8;
          color: #561d71;
          padding: 20px;
        }
        
        .card-result-chart {
          flex: 1; /* Chart takes remaining space */
        }

      #total-view-count {
        top: 20px;
        right: 20px;
        font-weight: bold;
        font-size: 1rem;
        color: #fff;
      }
    
      .card-qstn {
        background: transparent;
        box-shadow: none;
        padding: 0;
        padding: 12px 16px;
        background: linear-gradient(135deg, #8f57d3 0%, #067da5 100%);
        /* background: linear-gradient(135deg, #C33764 0%, #561d71 100%);*/
      }
    
      .title {
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 30px;
        color: #fff;
        padding: 12px 16px;
      }
    
      .poll-options {
        list-style: none;
        padding: 0;
        margin: 0 auto;
      }
    
      .poll-option {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        background: rgba(255, 255, 255, 0.15);
        padding: 12px 16px;
        border-radius: 12px;
      }
    
      .poll-option input[type="radio"] {
        width: 20px;
        height: 20px;
        accent-color: #ffffff;
      }
    
      .poll-option label {
        flex-grow: 1;
        font-weight: bold;
        color: #fff;
        cursor: pointer;
      }
    
      .poll-option div {
        flex-grow: 1;
        height: 8px;
        background: #ffffff40;
        border-radius: 4px;
        overflow: hidden;
      }
    
      .poll-option div > div {
        height: 100%;
        background: #ffffff80;
      }
      .optionn{
          width:1080px;
      }
      #submit-vote-button {
          display: none;
        }
      .next-btn-text, .next-btnn-mobile{
      display: none;
      }


    
      #submit-vote-button, #result-button ,.next-btnn{
        background: #ffffff;
        color: #561d71;
        padding: 10px 24px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 8px;
        border:1px solid #e0c6f8;;
        margin-top: 20px;
        cursor: pointer;
        transition: 0.3s;
      }
    
      #submit-vote-button:hover, #result-button:hover , .next-btnn:hover{
        background: #e0c6f8;;
      }
      .next-btn-sec {
          display: flex;
          justify-content: right;
          margin-top: 0.5rem; /* adds space above the button */
        }
        
        .next-btnn {
          margin-top: 0; 
          padding: 10px 100px;
        }
        
      /* QR Code Section */
      .card-qr {
        background: transparent;
        margin: 1rem auto 0;
        text-align: center;
      }
    
      .card-qr img {
        max-width: 250px;
        height: auto;
        border-radius: 12px;
        box-shadow: 0px 4px 12px rgba(0,0,0,0.1);
      }
      
      @media (max-width: 991px) {
      .next-btn-text, .next-btnn-mobile{
        display: inline-block;
        }
        a.next-btnn-mobile{
            justify-content: center;
            text-align: center;
              display:flex;
            background: #ffffff;
            color: #561d71;
            font-size: 16px;
            font-weight: bold;
            width: auto;
            margin-left: 300px;
            margin-right: 300px;
            border-radius: 8px;
            padding: 8px 15px;
            border:1px solid #e0c6f8;;
            margin-top: 2px;
            cursor: pointer;
        }
        .dashboard-2col {
          display: none;
        }
        .dashboard-2col-qstn {
          padding: 1.5rem;
        }
        .poll-options {
          padding: 0 10px;
        }
        .title {
          font-size: 1rem;
          font-weight: 600;
        }
        .poll-option {
          font-size: 0.8rem;
          width: 600px;
        }
      
        .next-btn-text {
            font-size: 15px;
            justify-content: center;
            text-align: center;
            font-weight: 600;
            margin-top: 200px;
        }
        .next-btnn{
            display: none;
        }
    
      }
    
      @media (min-width: 350px) and (max-width: 740px) {
        a.next-btnn-mobile{
            justify-content: center;
            text-align: center;
              display:flex;
            background: #ffffff;
            color: #561d71;
            font-size: 16px;
            font-weight: bold;
            width: auto;
            margin-left: 100px;
            margin-right: 100px;
            border-radius: 8px;
            padding: 8px 10px;
            border:1px solid #e0c6f8;;
            margin-top: 2px;
            cursor: pointer;
        }
        .next-btnn{
            display: none;
        }
        .next-btn-text {
            font-size: 15px;
            justify-content: center;
            text-align: center;
            font-weight: 600;
            margin-top: 200px;
        }
        
          
        .dashboard-2col {
          display: none;
        }
        .next-btn-sec{
            display: block;
            }
        .dashboard-2col-qstn {
          padding: 1.5rem;
        }
        .poll-options {
          padding: 0 10px;
        }
        .title {
          font-size: 1rem;
          font-weight: 600;
        }
        .poll-option {
          font-size: 0.8rem;
          width: 240px;
        }
      
      }

    </style>
  
  
  {% extends base_template %}
  {% block page_content %}




    {% if qstn_status == "Open" or qstn_status == "Reopen" or is_poll_admin != "True"  %}

  <!-- Question and Progress Bars -->
  <div class="dashboard-2col-qstn">
    {% if is_poll_admin == "True"  %}
    <h4 style="color:black;" id="total-view-count">PLAYERS: </h4>
    {% else %}
    <br><br><br>
    {% endif %}
    <!-- QR Code Card -->
    {% if frappe.form_dict.quest %}
          
  <!-- Existing Question Card -->
    <div class="card card-qstn"> 
      <h4 id="message-box"></h4>
      <div class="title" style="margin-bottom: 30px;">Q: {{ current_question.question }} </div>
      <ul class="poll-options">
              {% for opt in options %}
              <li class="poll-option" style="display: flex;  gap: 15px; margin-bottom: 10px;">                
                  <input type="radio" id="option{{ loop.index }}" name="selected_option" value="{{ opt.option }}" required>
                  <label for="option{{ loop.index }}" class="optionn" style=" font-weight: bold;">
                      {{ opt.option }}
                  </label>
              </li>
              {% endfor %}
          </ul>
       {% if is_poll_admin != "True" %}
        <button type="button" id="submit-vote-button" style="padding: 8px 20px; cursor: pointer; width:100px" class="submit-button">
          Submit
        </button>
        {% endif %}
        <!-- next_question_url -->
      {% if is_poll_admin == "True" %}
      <button type="button" id="result-button" class="result-button" style="padding: 8px 20px; cursor: pointer; width:100px">
        Result
      </button>
      {% endif %}
    </div>
    {% if is_poll_admin == "True" %}
   <div class="card card-qr">
    <img src="{{ pollqr }}" alt="{{ pollqr }}" style="width: 100%; max-width: 300px; height: auto; margin: auto;">
    </div>
    {% endif %}
    {% endif %}
  </div>
  {% endif %}
    <!-- Donut and Leaderboard Section -->
    <div class="dashboard-2col">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
      <!-- Results Breakdown -->
      {% if qstn_status == "Closed" and is_poll_admin == "True"  %}
      <div class="card card-result">
        <div class="card-result-answer">
            <!-- Selected Answer goes here -->
            Answer:
            <div class="anss"> 
                {{ answer }}
            </div>
          </div>
          <div class="card-result-chart">
        <div class="title">Results Breakdown</div>
        <canvas id="donutChart" width="" height=""></canvas>
      </div>
     </div>
    <script>
    const ctxDonut = document.getElementById('donutChart').getContext('2d');
      const donutChart = new Chart(ctxDonut, {
        type: 'doughnut',
        data: {
          labels: [
            {% for opt in optionss %}
              "{{ opt.option }}"{% if not loop.last %},{% endif %}
            {% endfor %}
          ],
          datasets: [{
            data: [
              {% for opt in optionss %}
                {{ opt.percent }}{% if not loop.last %},{% endif %}
              {% endfor %}
            ],
            backgroundColor: [
              {% for opt in optionss %}
                {% if loop.index == 1 %}"#FF6B6B"
                {% elif loop.index == 2 %}"#4ECDC4"
                {% elif loop.index == 3 %}"#FFD93D"
                {% elif loop.index == 4 %}"#5D5FEF"
                {% else %}"#ccc"{% endif %}
                {% if not loop.last %},{% endif %}
              {% endfor %}
            ],
            borderWidth: 1
          }]
        },
        options: {
          cutout: '60%',
          plugins: {
            legend: {
              position: 'bottom',
            }
          }
        }
      });
      </script>
      {% endif %}

      <!-- Leaderboard -->
      {% if qstn_status == "Closed" and is_poll_admin == "True" and show_leaderboard == "true" %}
      <div class="card card-leaderb">
        <div class="title">Leaderboard</div>
        <canvas id="leaderboardChart" width="" height="500" style="border-left:none;"></canvas>
      </div>

      <script>
        function pad(n) {
            return n < 10 ? '0' + n : n;
          }
      
          // Return "YYYY-MM-DD" for a Date
          function formatDate(d) {
            return d.getFullYear()
                 + '-' + pad(d.getMonth() + 1)
                 + '-' + pad(d.getDate());
          }
      
          async function loadLeaderboardData() {
            const today = new Date();
            const todayStr = formatDate(today);
      
            // Use the same date for both ends of the range
            const url = `/api/method/frappe.desk.leaderboard.get_energy_point_leaderboard`
                      + `?date_range=["${todayStr}","${todayStr}"]`
                      + `&limit=20`;
        try {
            const response = await fetch(url);
            const result   = await response.json();
            console.log("Leaderboard Data:", result);

            if (result.message && Array.isArray(result.message)) {
              // Step 1: Filter users who have points greater than 0
              const usersWithPoints = result.message.filter(user => user.value > 0);
          
              // Step 2: Take the first 20 users from the filtered list
              const top20Users = usersWithPoints.slice(0, 20);
          
              // Step 3: Extract labels and data
              const labels = top20Users.map(user => user.name);
              const data = top20Users.map(user => user.value);
          
              // Step 4: Render the chart
              renderLeaderboardChart(labels, data);
          } else {
              console.error("Invalid leaderboard data format:", result);
          }
          
    } catch (error) {
        console.error("Failed to load leaderboard data:", error);
    }
    }
  function renderLeaderboardChart(labels, data) {
  const ctxLeaderboard = document.getElementById('leaderboardChart').getContext('2d');

  new Chart(ctxLeaderboard, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: 'rgba(128, 90, 213, 0.7)',
        borderRadius: 4,
        barThickness: 25,
        categoryPercentage: 0, // Added: control gap between bars
        barPercentage: 0.8     // Added: control width of individual bar
      }]
    },
    options: {
      indexAxis: 'y',
      scales: {
        x: {
          beginAtZero: true,
          grid: {
            display: true,
            color: '#e5e7eb', // light gray lines
            borderColor: '#e5e7eb',
            drawBorder: false // ✅ Added: remove vertical line from X axis
          },
          ticks: {
            display: false
          }
        },
        y: {
          beginAtZero: true,
          grid: {
            display: true,
            color: '#e5e7eb', // light gray lines
            borderColor: '#e5e7eb',
            borderWidth: 0,
            drawBorder: false // already present ✅
          },
          ticks: {
            display: true,
            callback: function(value, index) {
              return `${data[index]}`; // Corrected template string
            },
            align: 'start',
            padding: 25,
            color: '#6B7280', // Tailwind slate-500
            font: {
              size: 14
            }
          }
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          enabled: false
        },
        datalabels: {
          anchor: 'center',
          align: 'center',
          color: '#ffffff',
          font: {
            weight: 'bold',
            size: 14
          },
          formatter: function(value, context) {
            return context.chart.data.labels[context.dataIndex]; // Show name in center
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}
  
// Load leaderboard data when the page content is loaded
window.addEventListener('DOMContentLoaded', loadLeaderboardData);
      </script>
      {% endif %}
    </div> 
  
  </div>

  {% if next_question_url and is_poll_admin == "True" %}
  <h5 class="next-btn-text">Ready for the Next One?</h5>
  <button id="goto_next_qstnn" class="next-btnn-mobile" >NEXT mob</button>


  <div class="next-btn-sec">
    <button id="goto_next_qstn" class="next-btnn" >NEXT</button>
  </div>
  
  {% endif %}

  {% if poll_status == "Closed" %}
  <script>
    setTimeout(function() {
        window.location.href = "/"; // after 2 seconds, redirect
    }, 100);
    </script>
  {% endif %}
</div>
<!-- right after your Chart.js import, or anywhere in <head> before your inline scripts -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script>

    <script>

      var next_question_url = "{{ next_question_url }}"
      var is_poll_admin = "{{ is_poll_admin }}"
      frappe.ready(() => {
        // Initialize Realtime
        frappe.realtime.init();
    
        // Listen for next question URL and redirect users
        frappe.realtime.on('goto_next_question_event', (next_url) => {
            console.log('Redirecting to:', next_url);
            window.location.href = next_url;  // Redirect user
        });
    
        // Admin-only section
        if (is_poll_admin == "True") {
            document.getElementById('goto_next_qstn').addEventListener('click', () => {
                const nextUrl = next_question_url;
                if (nextUrl) {
                    frappe.call({
                        method: 'antpoll.antpoll.doctype.community_poll.community_poll.send_next_question_url',
                        args: {
                            next_url: nextUrl
                        },
                        callback: function (r) {
                            if (r.message.status === "success") {
                                console.log("yess")
                            }
                        },
                        error: function (err) {
                            frappe.msgprint("Error broadcasting next question URL.");
                        }
                    });
                } 
        });
      // for mobile view
        document.getElementById('goto_next_qstnn').addEventListener('click', () => {
          const nextUrl = next_question_url;
          if (nextUrl) {
              frappe.call({
                  method: 'antpoll.antpoll.doctype.community_poll.community_poll.send_next_question_url',
                  args: {
                      next_url: nextUrl
                  },
                  callback: function (r) {
                      if (r.message.status === "success") {
                          console.log("yess")
                      }
                  },
                  error: function (err) {
                      frappe.msgprint("Error broadcasting next question URL.");
                  }
              });
          } 
  });

      }
      
    });
  

    document.addEventListener("DOMContentLoaded", function () {
    const questionName = "{{ current_question.name }}";
    const currentUser = "{{ frappe.session.user }}";
    const questionOwner = "{{ current_question.owner }}";
    const pollId = "{{ name }}";
    const user = "{{ frappe.session.user }}";

    // Redirect if no "quest" URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    if (!urlParams.get("quest")) {
        window.location.href = window.location.pathname + "?quest={{ doc.questions[0].question }}";
    }

    // Check if the user is logged in
    if (user === "Guest") {
        alert("You must be logged in to vote.");
        return;
    } else {
        // Track the user's view of the poll question (backend method)
        frappe.call({
            method: "antpoll.antpoll.doctype.community_poll.community_poll.track_poll_question_view",
            args: {
                question_name: questionName,
                poll_id: pollId,
            }
        });
    }

    function refreshViewCount() {
        frappe.call({
            method: "antpoll.antpoll.doctype.community_poll.community_poll.get_total_views",   // Change this to your method path
            args: {
                q_name: questionName,
                poll_id: pollId
            },
            callback: function(response) {
                if (response.message !== undefined) {
                    document.getElementById('total-view-count').innerText = "PLAYERS: " + response.message;
                }
            }
        });
    }

    if (is_poll_admin == "True") {
    setInterval(refreshViewCount, 2000);
    refreshViewCount();
    }

    // Function to show custom toast message
    function showCustomToast(message) {
        let toast = document.createElement("div");
        toast.id = "custom-toast";
        toast.style.position = "fixed";
        toast.style.top = "40%";
        toast.style.left = "50%";
        toast.style.transform = "translateX(-50%)";
        toast.style.backgroundColor = "#F8F8F8";
        toast.style.color = "#000";
        toast.style.padding = "40px 80px";
        toast.style.borderRadius = "10px";
        toast.style.boxShadow = "0px 4px 6px #F0F0F0";
        toast.style.zIndex = "9999";
        toast.style.fontSize = "16px";
        toast.style.textAlign = "center";
        toast.style.opacity = "1";
        toast.style.transition = "opacity 0.5s ease-in-out";
        toast.style.display = "flex";
        toast.style.flexDirection = "column";
        toast.style.alignItems = "center";
        toast.style.justifyContent = "center";
        toast.style.gap = "10px";

        let icon = document.createElement("img");
        icon.src = "/assets/antpoll/images/righticon.svg"; 
        icon.style.width = "34px";
        icon.style.height = "34px";

        let text = document.createElement("span");
        text.innerText = message;
        toast.appendChild(icon);
        toast.appendChild(text);
        document.body.appendChild(toast);

         setTimeout(() => {
        toast.style.opacity = "0";  
        setTimeout(() => {
            toast.remove();  
            location.reload(); 
        }, 500); 
    }, 2000);  
    }

    // Function to check if user has already voted
   function checkIfUserHasVoted() {
    console.log("calling check method!!!!!")
    frappe.call({
        method: "antpoll.antpoll.doctype.community_poll.community_poll.has_user_voted",
        args: {
            poll_id: pollId,
            qst_id: questionName,
            user: user
        },
        callback: function (response) {
            if (response.message && response.message.has_voted) {
                // If user has voted, hide radio buttons and the submit button
                document.querySelectorAll('input[type="radio"]').forEach(function (radio) {
                    radio.style.display = "none"; // Hide all radio buttons
                });
                document.getElementById("submit-vote-button").style.display = "none"; // Hide submit button
               
            } 
        }
        });
    }
    // Call to check if the user has already voted
    if (is_poll_admin != "True") {
    checkIfUserHasVoted();
    }

    
   // First hide the button
    document.getElementById("submit-vote-button").style.display = "none";

    // Attach event to all radio buttons
    document.querySelectorAll('input[name="selected_option"]').forEach(function (radio) {
        radio.addEventListener("change", function () {
            if (document.querySelector('input[name="selected_option"]:checked')) {
                document.getElementById("submit-vote-button").style.display = "block";
            } else {
                document.getElementById("submit-vote-button").style.display = "none";
            }
        });
    });


    if (is_poll_admin != "True") {
    // Submit vote logic
  document.getElementById("submit-vote-button").addEventListener("click", function () {
      let selectedOption = document.querySelector('input[name="selected_option"]:checked');
      let pollId = "{{ name }}";
      let questId = "{{ current_question.name }}";
      let user = "{{ frappe.session.user }}";

      if (!selectedOption) {
          alert("Please select an option to vote.");
          return;
      }

      let optionName = selectedOption.value;

      frappe.call({
          method: "antpoll.antpoll.doctype.community_poll.community_poll.cast_vote",
          args: {
              poll_id: pollId,
              qst_id: questId,
              option_name: optionName
          },
          callback: function (response) {
              console.log("Response:", response);  // Log the response for debugging
              if (response.message && response.message.VoteMsg) {
                  const data = response.message;
                  const voteMsg = data.VoteMsg;
                  // Show the "Thank you" message (custom toast) upon successful vote
                  showCustomToast(voteMsg);
              } else {
                  // Log and show an error message if something went wrong
                  console.error("Error in response:", response);
                  alert("Something went wrong, please try again.");
              }
          }
      });
  });
}

});

if (is_poll_admin == "True") {
// Result button
document.getElementById("result-button").addEventListener("click", function () {   
    let pollId = "{{ name }}";
    let questId = "{{ current_question.name }}";

    // Call the API to fetch the question results
    frappe.call({
        method: "antpoll.antpoll.doctype.community_poll.community_poll.question_result_show",
        args: {
            poll_id: pollId,
            qst_id: questId
        },
        callback: function (response) {
            console.log("Response:", response);  // Log the response for debugging
            
            if (response.message && response.message === "success") {
                console.log("yes!!!")
                location.reload();  // Reload the current page
            }
        }
    });
});
}


</script>
   
    {% endblock %}
