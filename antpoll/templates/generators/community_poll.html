<head>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">


<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

        body {
          background-image: url("/assets/antpoll/images/svgbg.svg") !important;
          font-family: 'Segoe UI', sans-serif;
          background-size: cover;
          background-repeat: no-repeat;
          margin: 0;
          padding: 0;
          height: 100vh;
        }
       
        .poll-section {
            display: flex;
            align-items: center;
            border: 5px solid rgb(219, 219, 219);
            justify-content: space-between;
            background: transparent;
            border-radius: 15px;
            padding: 40px 20px;
            flex-wrap: wrap;
        }
    
        .instruction-side {
            flex: 1 1 40%;
            padding: 0px 20px;
        }
    
        .instruction-side h1 {
            font-size: 3rem;
            color: #880e0e;
            font-weight: bold;
        }
        .instruction-side h1 span{
            font-size: 2.2rem;
            font-weight: bold;
            
            color: rgb(15, 15, 15);
        }
        .poll-section h4{
            color: rgb(22, 22, 22);
        }
        .instruction-side p {
            font-size:15px;
            color: #111111;
            max-width: 90%;
        }
    
        .timer {
            font-size: 2.5rem;
            font-weight: 700;
            margin-top: 20px;
            color: #880e0e;
        }
        
        .image-side {
            flex: 1 1 55%;
            text-align: center;
        }
    
        .poll-image {
            width: 100%;
            max-width: 650px;
            opacity: 0.95;
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.1));
            transition: transform 0.4s ease;
        }
    
        .poll-image:hover {
            transform: scale(1.02);
        }
        .qr-image {
            width: 300px;
            padding: 15px; /* Adds space inside the image container */
            border-radius: 20px; /* Makes the corners rounded */
            background-color: white; /* Optional: helps the padding show better */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); /* Optional: subtle shadow */
        }
        
        p.instructions-text {
            font-family: 'Poppins', sans-serif;
            font-size: 20px !important;
            line-height: 1 !important;
            color: #131212;
            font-weight: 500;
            padding: 0px 20px;
            border-radius: 10px;
            max-width: 900px;
        }
        

        .scan-qr-text{
            font-weight: 800;
            color: black;
        }
        .players{
            font-weight: 700;
            color: #000000;
            font-size: 25px;
            
        }
        .qr-timer-message{
            
            padding: 30px 30px;
            border-radius: 6px;
            color: #000000 !important;
            margin-top: 50px;
        }
        .animated-message {
            display: inline-block;
            position: relative;
            font-family: 'Poppins', sans-serif;
            font-size: 28px;
            font-weight: 500;
            line-height: 1.6;
            color: #880e0e!important;
            animation: drift 4s ease-in-out infinite alternate;
        }
        
        @keyframes drift {
            0% {
                transform: translate(0, 0);
            }
            100% {
                transform: translate(-10px, 10px);
            }
        }
    
        @media (max-width: 768px) {
            .poll-section {
                flex-direction: column;
                text-align: center;
            }
    
            .instruction-side, .image-side {
                flex: 1 1 100%;
            }
    
            .instruction-side h1 {
                font-size: 2rem;
            }
            .players{
               
                font-size: 22px;
            }
            .poll-image {
                width: 70%;
                max-width: 450px;
                opacity: 0.95;
                filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.1));
                transition: transform 0.4s ease;
            }
            .qr-timer-message{
               font-size: 16px;
            }
        }
        .poll-wrapper {
          display: flex;
          flex-direction: column;
          
        }
      
        .dashboard {
          width: 100%;
          margin: auto;
          padding: 2rem;
        }
      
        .dashboard-2col-qstn {
          display: flex;
          flex-direction: column;
          gap: 1rem;
          background: transparent;
          position: relative;
          color: white;
        }
        .dashboard-2col {
            display: grid;
            grid-template-columns: 400px 800px; /* First column smaller, second bigger */
            gap: 2rem;
            justify-content: center; /* Center the whole grid nicely */
            width: 100%;
          }
          
        .card-result, .card-leaderb {
          box-sizing: border-box;
          height: auto;
        }
          
        /* Specific styles for Result card */
        .card-result {
          display: flex;
          flex-direction: column; /* Arrange inside vertically */
          max-width: 400px;
          width: 100%;
          background: #f9f9f9; /* optional, light background */
          padding: 1rem; /* some padding inside */
          border-radius: 8px; /* rounded corners */
        }
          /* Specific styles for Leaderboard card */
          .card-leaderb {
          max-width: 800px;
          width: 100%;
          background: #ffffff; /* optional */
          padding: 1rem;
          border-radius: 8px;
        }
              
        /* Inside .card-result, two sections: answer and chart */
        .card-result-answer {
          margin-bottom: 1rem; /* gap between answer and chart */
          font-size: 1.2rem;
          font-weight: bold;
          padding: 20px 10px;
        }
        .card-result-answer .anss{
          background: #e0c6f8;
          color: #561d71;
          padding: 20px;
        }
        
        .card-result-chart {
          flex: 1; /* Chart takes remaining space */
        }

        /* Tablet View (<= 1024px) */
@media (max-width: 1024px) {
  .dashboard-2col {
    grid-template-columns: 1fr; /* Single column layout */
    gap: 1rem;
    padding: 0 1rem;
  }

  .card-result, .card-leaderb {
    max-width: 100%;
    width: 100%;
  }
}

/* Mobile View (<= 768px) */
@media (max-width: 768px) {
  .dashboard-2col {
    grid-template-columns: 1fr;
    gap: 1rem;
    padding: 0 1rem;
  }

  .card-result-answer {
    font-size: 1rem;
    padding: 15px 8px;
  }

  .card-result-answer .anss {
    padding: 15px;
  }
}

      #total-view-count {
        top: 20px;
        right: 20px;
        font-weight: bold;
        font-size: 1rem;
        color: #0e0d0d;
      }
    
      .card-qstn {
        background: transparent !important;
        box-shadow: none;
        padding: 0px 16px 16px 16px;
        box-shadow: 0.5 px 0.5px 10px black;
      }
      
    
      .title {
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 10px;
        color: #1f1f1f;
        padding: 0px 30px;
      }
    
      .poll-options {
        list-style: none;
        padding: 0;
        margin: 0 auto;
      }
    
      .poll-option {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        background: rgba(255, 255, 255, 0.15);
        padding: 12px 16px;
        border-radius: 18px;
      }
    
      .poll-option input[type="radio"] {
        width: 25px;
        height: 25px;
        accent-color: #1d1d1d;
      }
    
      .poll-option label {
        flex-grow: 1;
        font-weight: bold;
        color: #303030;
        cursor: pointer;
      }
    
      .poll-option div {
        flex-grow: 1;
        height: 8px;
        background: #ffffff40;
        border-radius: 4px;
        overflow: hidden;
      }
    
      .poll-option div > div {
        height: 100%;
        background: #ffffff80;
      }
      .optionn{
          width:1080px;
      }
      #submit-vote-button {
          display: none;
        }
      .next-btn-text, .next-btnn-mobile{
      display: none;
      }


    
      #submit-vote-button, #result-button ,.next-btnn{
        background: transparent;
        color: #181818;
        padding: 10px 24px;
        margin-left:35px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 8px;
        border:1px solid #8f8f8f;;
        margin-top: 20px;
        cursor: pointer;
        transition: 0.3s;
      }
    
      #submit-vote-button:hover, #result-button:hover , .next-btnn:hover{
        background: #9b7251;
        color: white
        ;
      }
      .next-btn-sec {
          display: flex;
          justify-content: center;
          margin-top: 0.5rem; /* adds space above the button */
        }
        
        .next-btnn {
          margin-top: 0; 
          padding: 10px 100px;
        }
        
      /* QR Code Section */
      .card-qr {
        background: transparent;
        margin: 1rem auto 0;
        text-align: center;
      }
    
      .card-qr img {
        max-width: 250px;
        height: auto;
        border-radius: 12px;
        box-shadow: 0px 4px 12px rgba(0,0,0,0.1);
      }
      
      @media (max-width: 991px) {
      .next-btn-text, .next-btnn-mobile{
        display: inline-block;
        }
        a.next-btnn-mobile{
            justify-content: center;
            text-align: center;
              display:flex;
            background: #ffffff;
            color: #561d71;
            font-size: 16px;
            font-weight: bold;
            width: auto;
            margin-left: 300px;
            margin-right: 300px;
            border-radius: 8px;
            padding: 8px 15px;
            border:1px solid #e0c6f8;;
            margin-top: 2px;
            cursor: pointer;
        }
     
        .dashboard-2col-qstn {
          padding: 1.5rem;
        }
        .poll-options {
          padding: 0 10px;
        }
        .title {
          font-size: 1rem;
          font-weight: 600;
        }
        .poll-option {
          font-size: 0.8rem;
          width: 600px;
        }
      
        .next-btn-text {
            font-size: 15px;
            justify-content: center;
            text-align: center;
            font-weight: 600;
            margin-top: 200px;
        }
        .next-btnn{
            display: none;
        }
    
      }
    
      @media (min-width: 350px) and (max-width: 740px) {
        .next-btnn{
            justify-content: center;
            text-align: center;
            display:flex;
            background: #ffffff;
            color: #561d71;
            font-size: 16px;
            font-weight: bold;
            width: auto;
            margin-left: 100px;
            margin-right: 100px;
            border-radius: 8px;
            padding: 8px 10px;
            border:1px solid #e0c6f8;;
            margin-top: 2px;
            cursor: pointer;
        }
       
        .next-btn-text {
            font-size: 15px;
            justify-content: center;
            text-align: center;
            font-weight: 600;
            margin-top: 200px;
        }
        
          
      
        .next-btn-sec{
            display: block;
            }
        .dashboard-2col-qstn {
          padding: 1.5rem;
        }
        .poll-options {
          padding: 0 10px;
        }
        .title {
          font-size: 1rem;
          font-weight: 600;
        }
        .poll-option {
          font-size: 0.8rem;
          width: 240px;
        }
      
      }
      #poll-qr-sectionn {
        display: none ; /* hide both initially */
    }
    .rules-label{
      margin-top:50px;
    }

    #loading-section {
      
      width: 100%;
      height: 100%;
      margin-top:30%;
      
      justify-content: center;
      align-items: center;
    }
    #loading-section p {
      color: #001225; /* Blue color */
      font-weight: bold;
    }
  
    #loading-section #countdown {
      font-size: 5rem;
      color: #880e0e; /* Blue color */
      font-weight: bold;
      
    }
  
    @media (max-width: 768px) {
      #loading-section #countdown {
        font-size: 4rem;
      }
      #loading-section {
        margin-top:30%;

      }
      .card-qr{
        display: none !important;
      }
    }
  
    @media (max-width: 480px) {
      #loading-section #countdown {
        font-size: 3rem;
      }
      #loading-section {
        margin-top:30%;

      }
      .card-qr{
        display: none !important;
      }
    }
    
    </style>
  
  </head>
  {% extends base_template %}
  {% block page_content %}

<body>
  

  <div class="poll-section" id="poll-qr-sectionn" >
        
    <!-- Instruction and Timer -->
    {% if is_poll_admin == "True" %}

    <div class="instruction-side" id="qr-section">
        <h1>Quick Quiz <br>
            <span class="">Ready to Guess? </span>
        </h1>
        {% if instructions %}
        <h5 class="rules-label hidden"><strong>RULES</strong> :
        </h5>
        <p class="instructions-text hidden"></p>
        {% endif %}

        <img class="qr-image" src="{{pollqr}}" alt="qr">
        <h5 class="mt-3 text-dark ml-3 scan-qr-text">SCAN THE QR FOR JOINING !</h5>
       
    </div>
    <!-- Image Section -->
    <div class="image-side" id="qr-section">
        
        <img src="/assets/antpoll/images/bgpoll.png" alt="Poll Image" class="poll-image">
        <p class="players" id="total-view-count" style="color:black;font-size:22px;">PLAYERS :  </p>

        <button id="start-poll-button" class="next-btnn" >START</button>


        {% if poll_start_duration %}
        <p id="countdown-timer" class="timer">{{poll_start_seconds}}</p>
        {% endif %}
    </div>
    {% else %}
    <h4 id="timer-message" class="qr-timer-message animated-message"><strong>Please wait,</strong> <br>starting the poll soon...
        <br>
    </h4>
   
    <img src="/assets/antpoll/images/bgpoll.png" alt="Poll Image" class="poll-image">
    {% endif %}

</div>

<div id="loading-section" class="text-center" style="display: none;">
  <p class="text-center">Please Wait a Moment..</p>
  <span id="countdown" class="text-center">{{ poll_start_seconds }}</span>
</div>

<div id="qst-section-mainn" >

    {% if qstn_status == "Open" or qstn_status == "Reopen" or is_poll_admin != "True"  %}

    <!-- Question and Progress Bars -->
    <div class="dashboard-2col-qstn">
    {% if is_poll_admin == "True"  %}
    <h4 style="color:black;" id="total-view-count">PLAYERS: </h4>
    {% else %}
    <br><br><br>
    {% endif %}
    <!-- QR Code Card -->
    {% if frappe.form_dict.quest %}
          
  <!-- Existing Question Card -->
    <div class="card card-qstn" id="card-qstn"> 
      <h4 id="message-box"></h4>
      <div class="title" style="margin-bottom: 30px;">Q: {{ current_question.question }} </div>
      <ul class="poll-options">
              {% for opt in options %}
              <li class="poll-option" style="display: flex;  gap: 15px; margin-bottom: 10px;">                
                  <input type="radio" id="option{{ loop.index }}" name="selected_option" value="{{ opt.option }}" required>
                  <label for="option{{ loop.index }}" class="optionn" style=" font-weight: bold;">
                      {{ opt.option }}
                  </label>
              </li>
              {% endfor %}
          </ul>
       {% if is_poll_admin != "True" %}
        <button type="button" id="submit-vote-button" style="padding: 8px 20px; cursor: pointer; width:100px" class="submit-button">
          Submit
        </button>
        {% endif %}
        <!-- next_question_url -->
      {% if is_poll_admin == "True" %}
      <button type="button" id="result-button" class="result-button" style="padding: 8px 20px; cursor: pointer; width:100px">
        Result
      </button>
      {% endif %}
    </div>
    {% if is_poll_admin == "True" %}
   <div class="card card-qr">
    <img src="{{ pollqr }}" alt="{{ pollqr }}" style="width: 100%; max-width: 300px; height: auto; margin: auto;">
    </div>
    {% endif %}
    {% endif %}
  </div>
  {% endif %}
    <!-- Donut and Leaderboard Section -->

    
    <div class="dashboard-2col" style="margin-top:100px;">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
      <!-- Results Breakdown -->
      {% if qstn_status == "Closed" and is_poll_admin == "True"  %}
      <div class="card card-result">
        <div class="card-result-answer">
            <!-- Selected Answer goes here -->
            Answer:
            <div class="anss"> 
                {{ answer }}
            </div>
          </div>
          <div class="card-result-chart">
        <div class="title">Results Breakdown</div>
        <canvas id="donutChart" width="" height=""></canvas>
      </div>
     </div>
    <script>
    const ctxDonut = document.getElementById('donutChart').getContext('2d');
      const donutChart = new Chart(ctxDonut, {
        type: 'doughnut',
        data: {
          labels: [
            {% for opt in optionss %}
              "{{ opt.option }}"{% if not loop.last %},{% endif %}
            {% endfor %}
          ],
          datasets: [{
            data: [
              {% for opt in optionss %}
                {{ opt.percent }}{% if not loop.last %},{% endif %}
              {% endfor %}
            ],
            backgroundColor: [
              {% for opt in optionss %}
                {% if loop.index == 1 %}"#FF6B6B"
                {% elif loop.index == 2 %}"#4ECDC4"
                {% elif loop.index == 3 %}"#FFD93D"
                {% elif loop.index == 4 %}"#5D5FEF"
                {% else %}"#ccc"{% endif %}
                {% if not loop.last %},{% endif %}
              {% endfor %}
            ],
            borderWidth: 1
          }]
        },
        options: {
          cutout: '60%',
          plugins: {
            legend: {
              position: 'bottom',
            }
          }
        }
      });
      </script>

      {% endif %}

      <!-- Leaderboard -->
      {% if qstn_status == "Closed" and is_poll_admin == "True" and show_leaderboard == "true" %}
      <div class="card card-leaderb">
        <div class="title">Leaderboard</div>
        <canvas id="leaderboardChart" width="" height="500" style="border-left:none;"></canvas>
      </div>

      <script>
        function pad(n) {
            return n < 10 ? '0' + n : n;
          }
      
          // Return "YYYY-MM-DD" for a Date
          function formatDate(d) {
            return d.getFullYear()
                 + '-' + pad(d.getMonth() + 1)
                 + '-' + pad(d.getDate());
          }
      
          async function loadLeaderboardData() {
            const today = new Date();
            const todayStr = formatDate(today);
      
            // Use the same date for both ends of the range
            const url = `/api/method/frappe.desk.leaderboard.get_energy_point_leaderboard`
                      + `?date_range=["${todayStr}","${todayStr}"]`
                      + `&limit=20`;
        try {
            const response = await fetch(url);
            const result   = await response.json();
            console.log("Leaderboard Data:", result);

            if (result.message && Array.isArray(result.message)) {
              // Step 1: Filter users who have points greater than 0
              const usersWithPoints = result.message.filter(user => user.value > 0);
          
              // Step 2: Take the first 20 users from the filtered list
              const top20Users = usersWithPoints.slice(0, 20);
          
              // Step 3: Extract labels and data
              const labels = top20Users.map(user => user.name);
              const data = top20Users.map(user => user.value);
          
              // Step 4: Render the chart
              renderLeaderboardChart(labels, data);
          } else {
              console.error("Invalid leaderboard data format:", result);
          }
          
    } catch (error) {
        console.error("Failed to load leaderboard data:", error);
    }
    }
  function renderLeaderboardChart(labels, data) {
  const ctxLeaderboard = document.getElementById('leaderboardChart').getContext('2d');

  new Chart(ctxLeaderboard, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: 'rgba(128, 90, 213, 0.7)',
        borderRadius: 4,
        barThickness: 25,
        categoryPercentage: 0, // Added: control gap between bars
        barPercentage: 0.8     // Added: control width of individual bar
      }]
    },
    options: {
      indexAxis: 'y',
      scales: {
        x: {
          beginAtZero: true,
          grid: {
            display: true,
            color: '#e5e7eb', // light gray lines
            borderColor: '#e5e7eb',
            drawBorder: false // ✅ Added: remove vertical line from X axis
          },
          ticks: {
            display: false
          }
        },
        y: {
          beginAtZero: true,
          grid: {
            display: true,
            color: '#e5e7eb', // light gray lines
            borderColor: '#e5e7eb',
            borderWidth: 0,
            drawBorder: false // already present ✅
          },
          ticks: {
            display: true,
            callback: function(value, index) {
              return `${data[index]}`; // Corrected template string
            },
            align: 'start',
            padding: 25,
            color: '#6B7280', // Tailwind slate-500
            font: {
              size: 14
            }
          }
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          enabled: false
        },
        datalabels: {
          anchor: 'center',
          align: 'center',
          color: '#ffffff',
          font: {
            weight: 'bold',
            size: 14
          },
          formatter: function(value, context) {
            return context.chart.data.labels[context.dataIndex]; // Show name in center
          }
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}
  
// Load leaderboard data when the page content is loaded
window.addEventListener('DOMContentLoaded', loadLeaderboardData);
      </script>
      
      {% endif %}

    

    </div> 
  {% if is_poll_admin !="True" and qstn_status == "Closed"%}
    <div id="points-feedback-section"
    style="display: none;  text-align: center; padding: 30px; background-color: #faf9f9; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); max-width: 600px; margin-left: auto; margin-right: auto;">

 <p id="points-feedback"
    style="font-size: 1.5rem; font-weight: 700; color: #1a202c;">
   🎯 Loading your points...
 </p>

 <p style="font-size: 1.25rem; color: #2f855a; font-weight: 500;">
   🎉 Congrats!
 </p>

</div>

</div>
    {% endif %}

  {% if next_question_url and is_poll_admin == "True" and qstn_status == "Closed" %}

  <div class="next-btn-sec">
    <button id="goto_next_qstn" class="next-btnn" >NEXT</button>
  </div>
  
  {% endif %}

  {% if poll_status == "Closed" %}
  <div style="margin-top: 20px; text-align: center; padding: 25px; border-radius: 10px; max-width: 600px; margin-left: auto; margin-right: auto;">
    <p style="font-size: 1.1rem; font-weight: 600; color: #000000; margin: 0;">
      Thank You For Participating!
    </p>
  </div>
{% endif %}

<!-- right after your Chart.js import, or anywhere in <head> before your inline scripts -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script>

    <script>

      var next_question_url = "{{ next_question_url }}"
      var is_poll_admin = "{{ is_poll_admin }}"
      var curQuest_url = "{{ current_question.name }}"
      const hasShownQR = "{{ has_shown_qr }}"
      const pollId = "{{ name }}";
      const RedirectionSeconds = "{{poll_start_seconds}}"

      const loadingSection = document.getElementById("loading-section");

      const first = document.getElementById("poll-qr-sectionn")
      const second = document.getElementById("qst-section-mainn")
      const starts = document.getElementById("start-poll-button")

      const countdownEl = document.getElementById("countdown");

      frappe.ready(() => {
        
        frappe.realtime.init();
    
        // Listen for next question URL and redirect users
        frappe.realtime.on('goto_next_question_event', (next_url) => {
            console.log('Redirecting to:', next_url);
            if (first) first.style.display = "none";
            if (second) second.style.display = "none";
        
            // Show loading section
            if (loadingSection) loadingSection.style.display = "block";
        
            // Start countdown
            let secondsLeft = RedirectionSeconds;
            countdownEl.textContent = secondsLeft;
        
            const interval = setInterval(() => {
                secondsLeft--;
                countdownEl.textContent = secondsLeft;
        
                if (secondsLeft <= 0) {
                    clearInterval(interval);
                    if (loadingSection) loadingSection.style.display = "none";
                    countdownEl.style.display = "none"
                    window.location.href = next_url;  // Redirect after countdown
                }
            }, 1000);
           
        });
     
        frappe.realtime.on('goto_cur_question_event', (cur_url) => {
          first.style.display = "none";
          second.style.display = "none";
          if (loadingSection) loadingSection.style.display = "block";
          let secondsLeft = RedirectionSeconds;
            countdownEl.textContent = secondsLeft;

            const interval = setInterval(() => {
              secondsLeft--;
              countdownEl.textContent = secondsLeft;
      
              if (secondsLeft <= 0) {
                  clearInterval(interval);
                  if (loadingSection) loadingSection.style.display = "none";
                  countdownEl.style.display = "none"
                  second.style.display = "block";
                
              }
          }, 1000);
        });
    

    
        // Admin-only section
        if (is_poll_admin == "True") {

          document.getElementById('start-poll-button').addEventListener('click', () => {
            const curQuest = curQuest_url;
            if(curQuest){
              frappe.call({
                method: 'antpoll.antpoll.doctype.community_poll.community_poll.send_cur_question_url',
                args: {
                    cur_url: curQuest,
                    poll_id:pollId
                },
                callback: function (r) {
                    if (r.message.status === "success") {
                        console.log("yess")
                    }
                },
                error: function (err) {
                    frappe.msgprint("Error broadcasting next question URL.");
                }
            });
            }
           });
          
            document.getElementById('goto_next_qstn').addEventListener('click', () => {
                const nextUrl = next_question_url;
                if (nextUrl) {
                    frappe.call({
                        method: 'antpoll.antpoll.doctype.community_poll.community_poll.send_next_question_url',
                        args: {
                            next_url: nextUrl
                        },
                        callback: function (r) {
                            if (r.message.status === "success") {
                                console.log("yess")
                            }
                        },
                        error: function (err) {
                            frappe.msgprint("Error broadcasting next question URL.");
                        }
                    });
                } 
        });
      
          document.getElementById('start-poll-btns').addEventListener('click', () => {
            
            const curQuest = curQuest_url;
           
            if (curQuest) {
                frappe.call({
                    method: 'antpoll.antpoll.doctype.community_poll.community_poll.send_cur_question_url',
                    args: {
                        cur_url: curQuest,
                        poll_id:pollId
                    },
                    callback: function (r) {
                        if (r.message.status === "success") {
                            console.log("yess")
                        }
                    },
                    error: function (err) {
                        frappe.msgprint("Error broadcasting next question URL.");
                    }
                });
            } 
        });

    }
    
  });
  

    document.addEventListener("DOMContentLoaded", function () {
    const questionName = "{{ current_question.name }}";
    const currentUser = "{{ frappe.session.user }}";
    const questionOwner = "{{ current_question.owner }}";
    const pollId = "{{ name }}";
    const user = "{{ frappe.session.user }}";
    


    if (hasShownQR === "1") {
        if (first) first.style.display = "none";
        if (second) second.style.display = "block";
    } else {
        if (first) first.style.display = "flex";
        if (second) second.style.display = "none";
    }

    // Redirect if no "quest" URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    if (!urlParams.get("quest")) {
        window.location.href = window.location.pathname + "?quest={{ doc.questions[0].question }}";
    }

    // Check if the user is logged in
    if (user === "Guest") {
        alert("You must be logged in to vote.");
        return;
    } else {
        // Track the user's view of the poll question (backend method)
        frappe.call({
            method: "antpoll.antpoll.doctype.community_poll.community_poll.track_poll_question_view",
            args: {
                question_name: questionName,
                poll_id: pollId,
            }
        });
    }

    function refreshViewCount() {
        frappe.call({
            method: "antpoll.antpoll.doctype.community_poll.community_poll.get_total_views",   // Change this to your method path
            args: {
                q_name: questionName,
                poll_id: pollId
            },
            callback: function(response) {
                if (response.message !== undefined) {
                    document.getElementById('total-view-count').innerText = "PLAYERS: " + response.message;
                }
            }
        });
    }

    if (is_poll_admin == "True") {
    setInterval(refreshViewCount, 2000);
    refreshViewCount();
    }


    // Function to show custom toast message
    function showCustomToast(message) {
        let toast = document.createElement("div");
        toast.id = "custom-toast";
        toast.style.position = "fixed";
        toast.style.top = "40%";
        toast.style.left = "50%";
        toast.style.transform = "translateX(-50%)";
        toast.style.backgroundColor = "#F8F8F8";
        toast.style.color = "#000";
        toast.style.padding = "40px 80px";
        toast.style.borderRadius = "10px";
        toast.style.boxShadow = "0px 4px 6px #F0F0F0";
        toast.style.zIndex = "9999";
        toast.style.fontSize = "16px";
        toast.style.textAlign = "center";
        toast.style.opacity = "1";
        toast.style.transition = "opacity 0.5s ease-in-out";
        toast.style.display = "flex";
        toast.style.flexDirection = "column";
        toast.style.alignItems = "center";
        toast.style.justifyContent = "center";
        toast.style.gap = "10px";

        let icon = document.createElement("img");
        icon.src = "/assets/antpoll/images/righticon.svg"; 
        icon.style.width = "34px";
        icon.style.height = "34px";

        let text = document.createElement("span");
        text.innerText = message;
        toast.appendChild(icon);
        toast.appendChild(text);
        document.body.appendChild(toast);

         setTimeout(() => {
        toast.style.opacity = "0";  
        setTimeout(() => {
            toast.remove();  
            location.reload(); 
        }, 500); 
    }, 2000);  
    }

    // Function to check if user has already voted
   function checkIfUserHasVoted() {
    console.log("calling check method!!!!!")
    frappe.call({
        method: "antpoll.antpoll.doctype.community_poll.community_poll.has_user_voted",
        args: {
            poll_id: pollId,
            qst_id: questionName,
            user: user
        },
        callback: function (response) {
            if (response.message && response.message.has_voted) {
                // If user has voted, hide radio buttons and the submit button
                document.querySelectorAll('input[type="radio"]').forEach(function (radio) {
                    radio.style.display = "none"; // Hide all radio buttons
                });
                document.getElementById("submit-vote-button").style.display = "none"; // Hide submit button
               
            } 
        }
        });
    }
    // Call to check if the user has already voted
    if (is_poll_admin != "True") {
    checkIfUserHasVoted();
    }

    
   // First hide the button
    document.getElementById("submit-vote-button").style.display = "none";

    // Attach event to all radio buttons
    document.querySelectorAll('input[name="selected_option"]').forEach(function (radio) {
        radio.addEventListener("change", function () {
            if (document.querySelector('input[name="selected_option"]:checked')) {
                document.getElementById("submit-vote-button").style.display = "block";
            } else {
                document.getElementById("submit-vote-button").style.display = "none";
            }
        });
    });


    if (is_poll_admin != "True") {
    // Submit vote logic
  document.getElementById("submit-vote-button").addEventListener("click", function () {
      let selectedOption = document.querySelector('input[name="selected_option"]:checked');
      let pollId = "{{ name }}";
      let questId = "{{ current_question.name }}";
      let user = "{{ frappe.session.user }}";

      if (!selectedOption) {
          alert("Please select an option to vote.");
          return;
      }

      let optionName = selectedOption.value;

      frappe.call({
          method: "antpoll.antpoll.doctype.community_poll.community_poll.cast_vote",
          args: {
              poll_id: pollId,
              qst_id: questId,
              option_name: optionName
          },
          callback: function (response) {
              console.log("Response:", response);  // Log the response for debugging
              if (response.message && response.message.VoteMsg) {
                  const data = response.message;
                  const voteMsg = data.VoteMsg;
                  // Show the "Thank you" message (custom toast) upon successful vote
                  showCustomToast(voteMsg);
              } else {
                  // Log and show an error message if something went wrong
                  console.error("Error in response:", response);
                  alert("Something went wrong, please try again.");
              }
          }
      });
  });
}

    function pad(n) {
      return n < 10 ? '0' + n : n;
    }

    // Return "YYYY-MM-DD" for a Date
    function formatDate(d) {
      return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate());
    }

    async function loadUserPointsStatus() {
      const currentUser = "{{ frappe.session.user }}";
      console.log("Current user (session email):", currentUser);
    
      const today = new Date();
      const todayStr = formatDate(today);
    
      const url = `/api/method/frappe.desk.leaderboard.get_energy_point_leaderboard`
                + `?date_range=["${todayStr}","${todayStr}"]`;
    
      try {
        console.log("Fetching leaderboard data from URL:", url);
        const response = await fetch(url);
    
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
    
        const result = await response.json();
        const leaderboard = result.message || [];
        console.log("Leaderboard:", leaderboard);
    
        if (Array.isArray(leaderboard)) {
          const userEntry = leaderboard.find(entry => {
            const match = entry.formatted_name?.match(/user-profile\/(.*?)">/);
            const email = match ? match[1] : null;
            console.log("Checking entry:", email, "vs", currentUser);
    
            return email && currentUser &&
                   email.toLowerCase().trim() === currentUser.toLowerCase().trim();
          });
          const firstEntry = leaderboard[0];
          let feedbackText = "🙁 No points recorded yet.";
          if (userEntry) {
            const match = userEntry.formatted_name?.match(/user-profile\/(.*?)">/);
            const email = match ? match[1] : null;
            const firstMatch = firstEntry.formatted_name?.match(/user-profile\/(.*?)">/);
            const firstEmail = firstMatch ? firstMatch[1] : null;
    
            if (email === firstEmail) {
              feedbackText = `🏆 You're leading with <strong>${userEntry.value}</strong> points!`;
            } else {
              feedbackText = `✅ You earned <strong>${userEntry.value}</strong> points.`;
            }
          }
    
          const feedbackEl = document.getElementById("points-feedback");
          if (feedbackEl) {
            feedbackEl.innerHTML = feedbackText;
            document.getElementById("points-feedback-section").style.display = "block";
            document.getElementById("card-qstn").style.display = "none";
          }
        } else {
          console.warn("Leaderboard is not an array:", leaderboard);
        }
      } catch (err) {
        console.error("Failed to load leaderboard points:", err.message);
      }
    }
    

    loadUserPointsStatus()

    });

if (is_poll_admin == "True") {
// Result button
document.getElementById("result-button").addEventListener("click", function () {   
    let pollId = "{{ name }}";
    let questId = "{{ current_question.name }}";

    // Call the API to fetch the question results
    frappe.call({
        method: "antpoll.antpoll.doctype.community_poll.community_poll.question_result_show",
        args: {
            poll_id: pollId,
            qst_id: questId
        },
        callback: function (response) {
            console.log("Response:", response);  // Log the response for debugging
            
            if (response.message && response.message === "success") {
                console.log("yes!!!")
                location.reload();  // Reload the current page
            }
        }
    });
    

});
}


</script>
</body>
    {% endblock %}
